<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Laboratorium Jalan Raya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .gradient-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .hidden-section {
            display: none !important;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="gradient-header text-white py-6 shadow-lg">
        <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-3 mb-4 md:mb-0">
                <div class="bg-indigo-500 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.628.283a2 2 0 01-1.186.12l-2.011-.402a2 2 0 01-1.358-1.213L6.041 11.2a2 2 0 00-1.213-1.358l-2.011-.402a2 2 0 01-1.186-.12l-.628-.283a2 2 0 00-3.86.517l-2.387.477a2 2 0 00-1.022.547V18a2 2 0 002 2h11a2 2 0 002-2v-2.572z" />
                    </svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight uppercase">Lab Jalan Raya</h1>
            </div>
            <div id="auth-status" class="text-xs font-medium bg-slate-700/50 px-4 py-2 rounded-full border border-slate-600 flex items-center gap-2">
                <div class="loader"></div> Mengamankan Koneksi...
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 -mt-8 flex-grow w-full">
        <!-- Dashboard Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-slate-100">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2 text-center">Selamat Datang di Database Laboratorium Jalan Raya</h2>
            <p class="text-slate-500 text-center mb-6 max-w-xl mx-auto text-sm">Silahkan isi rencana praktikum atau penelitian anda melalui menu di bawah ini.</p>

            <div class="flex justify-center mb-10">
                <button id="btn-open-daily" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg transition-all active:scale-95">
                    <span>ðŸ“…</span>
                    <span>Cek Kegiatan Hari Ini</span>
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <button id="btn-open-p" class="group p-6 border-2 border-slate-100 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition-all text-left">
                    <div class="bg-indigo-100 text-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold mb-1">Rencana Praktikum</h3>
                    <p class="text-xs text-slate-500">Penjadwalan untuk kelompok praktikan reguler.</p>
                </button>

                <button id="btn-open-n" class="group p-6 border-2 border-slate-100 rounded-2xl hover:border-emerald-500 hover:bg-emerald-50 transition-all text-left">
                    <div class="bg-emerald-100 text-emerald-600 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold mb-1">Rencana Penelitian</h3>
                    <p class="text-xs text-slate-500">Penjadwalan untuk tugas akhir atau riset dosen.</p>
                </button>
            </div>
        </div>

        <!-- Section Form Praktikum -->
        <section id="form-praktikum" class="hidden-section bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden mb-12">
            <div class="bg-indigo-600 px-6 py-4 text-white flex justify-between items-center">
                <h3 id="p-form-title" class="font-bold uppercase tracking-wider text-sm">Form Rencana Praktikum</h3>
                <button onclick="window.hideAllForms()" class="hover:bg-indigo-700 p-1 rounded transition">âœ•</button>
            </div>
            <form id="praktikumForm" class="p-8 grid md:grid-cols-2 gap-6">
                <input type="hidden" id="p-id" value="">
                <div>
                    <label class="block text-sm font-semibold mb-2">Kelompok</label>
                    <input type="text" id="p-kelompok" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Modul Praktikum</label>
                    <input type="text" id="p-modul" required placeholder="Ketik nama modul praktikum..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Asisten Praktikum</label>
                    <input type="text" id="p-asisten" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Tanggal</label>
                    <input type="date" id="p-tanggal" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Mulai</label>
                    <input type="time" id="p-mulai" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Selesai</label>
                    <input type="time" id="p-selesai" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold mb-2">List Alat dan Bahan</label>
                    <textarea id="p-alat-bahan" required placeholder="Tuliskan alat dan bahan yang digunakan..." rows="3" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold mb-2">Request Tambahan <span class="text-slate-400 font-normal">(Opsional)</span></label>
                    <textarea id="p-request" placeholder="Tuliskan jika ada permintaan khusus..." rows="2" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <p class="text-[10px] text-slate-400 mt-1 italic">Contoh: tolong hidupkan waterbath jam 12:00</p>
                </div>
                <button type="submit" id="p-submit-btn" class="md:col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all">Simpan Jadwal</button>
            </form>
        </section>

        <!-- Section Form Penelitian -->
        <section id="form-penelitian" class="hidden-section bg-white rounded-2xl shadow-lg border border-emerald-100 overflow-hidden mb-12">
            <div class="bg-emerald-600 px-6 py-4 text-white flex justify-between items-center">
                <h3 id="n-form-title" class="font-bold uppercase tracking-wider text-sm">Form Rencana Penelitian</h3>
                <button onclick="window.hideAllForms()" class="hover:bg-emerald-700 p-1 rounded transition">âœ•</button>
            </div>
            <form id="penelitianForm" class="p-8 grid md:grid-cols-2 gap-6">
                <input type="hidden" id="n-id" value="">
                <div>
                    <label class="block text-sm font-semibold mb-2">Nama Lengkap</label>
                    <input type="text" id="n-nama" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">NPM</label>
                    <input type="text" id="n-npm" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold mb-2">Rencana Aktivitas</label>
                    <textarea id="n-aktivitas" rows="2" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold mb-2">List Alat dan Bahan</label>
                    <textarea id="n-alat-bahan" required placeholder="Tuliskan alat dan bahan yang digunakan..." rows="3" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold mb-2">Request Tambahan <span class="text-slate-400 font-normal">(Opsional)</span></label>
                    <textarea id="n-request" placeholder="Tuliskan jika ada permintaan khusus..." rows="2" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                    <p class="text-[10px] text-slate-400 mt-1 italic">Contoh: tolong hidupkan waterbath jam 12:00</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Tanggal</label>
                    <input type="date" id="n-tanggal" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="time" id="n-mulai" required class="w-full px-3 py-3 bg-slate-50 border border-slate-200 rounded-xl">
                    <input type="time" id="n-selesai" required class="w-full px-3 py-3 bg-slate-50 border border-slate-200 rounded-xl">
                </div>
                <button type="submit" id="n-submit-btn" class="md:col-span-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all">Simpan Jadwal Penelitian</button>
            </form>
        </section>

        <!-- Rekap Buttons & PDF Download -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-12">
            <div class="space-y-3">
                <button id="btn-toggle-p" class="w-full bg-indigo-900 text-white px-6 py-4 rounded-xl hover:bg-indigo-950 transition flex items-center justify-between shadow-md">
                    <span class="flex items-center gap-2 font-semibold italic text-sm">ðŸ“˜ LOG JADWAL PRAKTIKUM</span>
                    <span>â–¼</span>
                </button>
                <button id="btn-pdf-p" class="w-full bg-white text-indigo-900 border-2 border-indigo-900 px-6 py-3 rounded-xl hover:bg-indigo-50 transition text-xs font-bold flex items-center justify-center gap-2">
                    ðŸ“¥ DOWNLOAD PDF PRAKTIKUM
                </button>
            </div>
            <div class="space-y-3">
                <button id="btn-toggle-n" class="w-full bg-emerald-900 text-white px-6 py-4 rounded-xl hover:bg-emerald-950 transition flex items-center justify-between shadow-md">
                    <span class="flex items-center gap-2 font-semibold italic text-sm">ðŸ”¬ LOG JADWAL PENELITIAN</span>
                    <span>â–¼</span>
                </button>
                <button id="btn-pdf-n" class="w-full bg-white text-emerald-900 border-2 border-emerald-900 px-6 py-3 rounded-xl hover:bg-emerald-50 transition text-xs font-bold flex items-center justify-center gap-2">
                    ðŸ“¥ DOWNLOAD PDF PENELITIAN
                </button>
            </div>
        </div>

        <!-- Tables -->
        <section id="log-praktikum-section" class="hidden-section mb-12 animate-in slide-in-from-top-2">
            <div class="bg-white rounded-2xl shadow-xl border border-indigo-100 overflow-hidden">
                <div class="overflow-x-auto p-4">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-[10px] font-bold">
                            <tr>
                                <th class="px-4 py-3">Kelompok</th>
                                <th class="px-4 py-3">Modul & Request</th>
                                <th class="px-4 py-3">Alat & Bahan</th>
                                <th class="px-4 py-3">Asisten</th>
                                <th class="px-4 py-3">Waktu</th>
                                <th class="px-4 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-praktikum" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="log-penelitian-section" class="hidden-section mb-20 animate-in slide-in-from-top-2">
            <div class="bg-white rounded-2xl shadow-xl border border-emerald-100 overflow-hidden">
                <div class="overflow-x-auto p-4">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-[10px] font-bold">
                            <tr>
                                <th class="px-4 py-3">Nama/NPM</th>
                                <th class="px-4 py-3">Aktivitas & Request</th>
                                <th class="px-4 py-3">Alat & Bahan</th>
                                <th class="px-4 py-3">Tanggal</th>
                                <th class="px-4 py-3">Sesi</th>
                                <th class="px-4 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-penelitian" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden-section fixed inset-0 z-[100] modal-overlay flex items-center justify-center px-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center animate-slide-up">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h4 class="text-xl font-bold mb-2">Selesai!</h4>
            <p id="modal-msg" class="text-slate-500 mb-6 text-sm"></p>
            <button onclick="window.closeModal()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-black transition">Tutup</button>
        </div>
    </div>

    <!-- Daily Activities Modal -->
    <div id="daily-modal" class="hidden-section fixed inset-0 z-[110] modal-overlay flex items-center justify-center px-4">
        <div class="bg-white rounded-3xl p-6 max-w-2xl w-full shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold text-slate-800">Kegiatan Berlangsung Hari Ini</h3>
                <button onclick="window.closeDailyModal()" class="text-slate-400 hover:text-slate-600 text-xl">âœ•</button>
            </div>
            <div id="daily-date-label" class="mb-5 text-indigo-600 font-bold bg-indigo-50 inline-block px-4 py-1 rounded-full text-xs"></div>
            <div id="daily-content" class="max-h-[60vh] overflow-y-auto pr-2 space-y-6"></div>
            <div class="mt-8 text-right">
                <button onclick="window.closeDailyModal()" class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-bold hover:bg-black transition text-sm">Selesai</button>
            </div>
        </div>
    </div>

    <footer class="bg-slate-900 text-slate-500 py-10 mt-auto border-t border-slate-800">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-sm font-medium">Â© 2024 Laboratorium Jalan Raya - Fakultas Teknik</p>
        </div>
    </footer>

    <!-- Firebase SDK & Config -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Deteksi Otomatis Lingkungan (Gunakan config internal jika di Canvas, config manual jika dideploy)
        const getFirebaseConfig = () => {
            if (typeof __firebase_config !== 'undefined') {
                return JSON.parse(__firebase_config);
            }
            return {
                apiKey: "AIzaSyDeTZGhTFhMTBszXY0Ji2aAe5VhFZNUjLU",
                authDomain: "jpp-jadwal-praktikum-peneliti.firebaseapp.com",
                projectId: "jpp-jadwal-praktikum-peneliti",
                storageBucket: "jpp-jadwal-praktikum-peneliti.firebasestorage.app",
                messagingSenderId: "592641758027",
                appId: "1:592641758027:web:297d087174ca12e81dcece",
                measurementId: "G-DT6DZ1PM1N"
            };
        };

        const app = initializeApp(getFirebaseConfig());
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : "road-lab-scheduling-app";

        let currentUser = null;
        let praktikumData = [];
        let penelitianData = [];

        // Logika Autentikasi yang diperbaiki
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    // Gunakan custom token jika berjalan di Canvas
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Gunakan anonymous jika di deploy eksternal (GitHub/Vercel)
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('auth-status').innerHTML = "ðŸ”´ Gagal Terkoneksi";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-status').innerHTML = "ðŸŸ¢ Cloud Aktif & Real-time";
                syncData();
            } else {
                initAuth();
            }
        });

        initAuth();

        // Ambil Data Real-time (Snapshot)
        function syncData() {
            if (!currentUser) return;
            
            // Path strict sesuai aturan RULE 1
            const pRef = collection(db, 'artifacts', appId, 'public', 'data', 'praktikum');
            onSnapshot(pRef, (snapshot) => {
                praktikumData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderP();
            }, (error) => console.error("Firestore sync error (p):", error));

            const nRef = collection(db, 'artifacts', appId, 'public', 'data', 'penelitian');
            onSnapshot(nRef, (snapshot) => {
                penelitianData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderN();
            }, (error) => console.error("Firestore sync error (n):", error));
        }

        // Render Tabel Praktikum
        function renderP() {
            const tbody = document.getElementById('table-praktikum');
            if (!tbody) return;
            tbody.innerHTML = praktikumData.map(item => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-4 py-4 font-bold text-indigo-900">${item.kelompok}</td>
                    <td class="px-4 py-4 text-slate-600">
                        <div class="font-medium">${item.modul}</div>
                        ${item.request ? `<div class="text-[10px] text-indigo-500 italic mt-1 leading-tight">Req: ${item.request}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 text-slate-500 truncate max-w-[150px]" title="${item.alatBahan}">${item.alatBahan}</td>
                    <td class="px-4 py-4 text-slate-500">${item.asisten}</td>
                    <td class="px-4 py-4 text-xs font-semibold">${item.tanggal}<br><span class="text-slate-400 italic">${item.sesi}</span></td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="window.prepareEditP('${item.id}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition">âœŽ</button>
                            <button onclick="window.confirmDelete('${item.id}', 'praktikum')" class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition">ðŸ—‘</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            if (praktikumData.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400 italic font-medium">Belum ada data praktikum</td></tr>';
        }

        // Render Tabel Penelitian
        function renderN() {
            const tbody = document.getElementById('table-penelitian');
            if (!tbody) return;
            tbody.innerHTML = penelitianData.map(item => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-4 py-4"><b>${item.nama}</b><br><small class="text-slate-400">${item.npm}</small></td>
                    <td class="px-4 py-4 text-slate-600">
                        <div class="font-medium">${item.aktivitas}</div>
                        ${item.request ? `<div class="text-[10px] text-emerald-600 italic mt-1 leading-tight">Req: ${item.request}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 text-slate-500 truncate max-w-[150px]" title="${item.alatBahan}">${item.alatBahan}</td>
                    <td class="px-4 py-4 font-medium text-slate-700">${item.tanggal}</td>
                    <td class="px-4 py-4 text-xs italic text-slate-500">${item.sesi}</td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="window.prepareEditN('${item.id}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition">âœŽ</button>
                            <button onclick="window.confirmDelete('${item.id}', 'penelitian')" class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition">ðŸ—‘</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            if (penelitianData.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400 italic font-medium">Belum ada data penelitian</td></tr>';
        }

        // Actions Global
        window.confirmDelete = async (id, type) => {
            if (!currentUser) return;
            if (confirm("Hapus jadwal ini selamanya?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id));
                } catch (e) { console.error(e); }
            }
        };

        window.prepareEditP = (id) => {
            const item = praktikumData.find(d => d.id === id);
            if (!item) return;
            document.getElementById('p-id').value = id;
            document.getElementById('p-kelompok').value = item.kelompok;
            document.getElementById('p-modul').value = item.modul;
            document.getElementById('p-asisten').value = item.asisten;
            document.getElementById('p-tanggal').value = item.tanggal;
            document.getElementById('p-alat-bahan').value = item.alatBahan || "";
            document.getElementById('p-request').value = item.request || "";
            const [m, s] = item.sesi.split(' - ');
            document.getElementById('p-mulai').value = m || "";
            document.getElementById('p-selesai').value = s || "";
            document.getElementById('p-form-title').innerText = "Edit Jadwal Praktikum";
            document.getElementById('p-submit-btn').innerText = "Update Jadwal";
            window.openForm('praktikum');
        };

        window.prepareEditN = (id) => {
            const item = penelitianData.find(d => d.id === id);
            if (!item) return;
            document.getElementById('n-id').value = id;
            document.getElementById('n-nama').value = item.nama;
            document.getElementById('n-npm').value = item.npm;
            document.getElementById('n-aktivitas').value = item.aktivitas;
            document.getElementById('n-tanggal').value = item.tanggal;
            document.getElementById('n-alat-bahan').value = item.alatBahan || "";
            document.getElementById('n-request').value = item.request || "";
            const [m, s] = item.sesi.split(' - ');
            document.getElementById('n-mulai').value = m || "";
            document.getElementById('n-selesai').value = s || "";
            document.getElementById('n-form-title').innerText = "Edit Jadwal Penelitian";
            document.getElementById('n-submit-btn').innerText = "Update Jadwal";
            window.openForm('penelitian');
        };

        // Form Submit Logic
        document.getElementById('praktikumForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const docId = document.getElementById('p-id').value;
            const payload = {
                kelompok: document.getElementById('p-kelompok').value,
                modul: document.getElementById('p-modul').value,
                asisten: document.getElementById('p-asisten').value,
                tanggal: document.getElementById('p-tanggal').value,
                alatBahan: document.getElementById('p-alat-bahan').value,
                request: document.getElementById('p-request').value,
                sesi: `${document.getElementById('p-mulai').value} - ${document.getElementById('p-selesai').value}`,
                updatedAt: Date.now()
            };
            try {
                if (docId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'praktikum', docId), payload);
                    showSuccessModal("Jadwal praktikum diperbarui.");
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'praktikum'), payload);
                    showSuccessModal("Rencana praktikum tercatat.");
                }
                window.hideAllForms();
            } catch (err) { console.error(err); }
        });

        document.getElementById('penelitianForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const docId = document.getElementById('n-id').value;
            const payload = {
                nama: document.getElementById('n-nama').value,
                npm: document.getElementById('n-npm').value,
                aktivitas: document.getElementById('n-aktivitas').value,
                tanggal: document.getElementById('n-tanggal').value,
                alatBahan: document.getElementById('n-alat-bahan').value,
                request: document.getElementById('n-request').value,
                sesi: `${document.getElementById('n-mulai').value} - ${document.getElementById('n-selesai').value}`,
                updatedAt: Date.now()
            };
            try {
                if (docId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'penelitian', docId), payload);
                    showSuccessModal("Jadwal penelitian diperbarui.");
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'penelitian'), payload);
                    showSuccessModal("Rencana penelitian tercatat.");
                }
                window.hideAllForms();
            } catch (err) { console.error(err); }
        });

        // Modal Daily
        window.openDailyModal = () => {
            const today = new Date().toLocaleDateString('en-CA'); // Format YYYY-MM-DD sesuai input date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('daily-date-label').innerText = new Date().toLocaleDateString('id-ID', options);
            
            const todayP = praktikumData.filter(d => d.tanggal === today);
            const todayN = penelitianData.filter(d => d.tanggal === today);
            const content = document.getElementById('daily-content');
            
            if (todayP.length === 0 && todayN.length === 0) {
                content.innerHTML = '<div class="text-center py-12"><p class="text-slate-400 italic font-medium">Tidak ada kegiatan hari ini.</p></div>';
            } else {
                let html = '';
                if (todayP.length > 0) {
                    html += `<div class="space-y-3"><div class="text-indigo-700 font-bold text-xs uppercase mb-2">Praktikum</div>`;
                    todayP.forEach(p => html += `<div class="p-4 bg-indigo-50 border border-indigo-100 rounded-2xl"><div class="font-bold text-indigo-900">${p.kelompok} (${p.sesi})</div><div class="text-xs text-slate-600">${p.modul}</div>${p.request ? `<div class="text-[10px] text-indigo-500 italic mt-1 italic">Note: ${p.request}</div>` : ''}</div>`);
                    html += `</div>`;
                }
                if (todayN.length > 0) {
                    html += `<div class="space-y-3 mt-4"><div class="text-emerald-700 font-bold text-xs uppercase mb-2">Penelitian</div>`;
                    todayN.forEach(n => html += `<div class="p-4 bg-emerald-50 border border-emerald-100 rounded-2xl"><div class="font-bold text-emerald-900">${n.nama} (${n.sesi})</div><div class="text-xs text-slate-600">${n.aktivitas}</div>${n.request ? `<div class="text-[10px] text-emerald-600 italic mt-1 italic">Note: ${n.request}</div>` : ''}</div>`);
                    html += `</div>`;
                }
                content.innerHTML = html;
            }
            document.getElementById('daily-modal').classList.remove('hidden-section');
        };

        // PDF Generation
        window.downloadPDF = (type) => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const titleStr = type === 'praktikum' ? 'LOG JADWAL PRAKTIKUM' : 'LOG JADWAL PENELITIAN';
            const dataArr = type === 'praktikum' ? praktikumData : penelitianData;
            pdf.setFontSize(14).setFont("helvetica", "bold").text(titleStr, 105, 20, { align: 'center' });
            pdf.setFontSize(10).text("LABORATORIUM JALAN RAYA", 105, 26, { align: 'center' });
            const cols = type === 'praktikum' 
                ? ["Kelompok", "Modul & Req", "Alat & Bahan", "Asisten", "Tanggal", "Sesi"]
                : ["Nama/NPM", "Aktivitas & Req", "Alat & Bahan", "Tanggal", "Sesi"];
            const rows = type === 'praktikum'
                ? dataArr.map(d => [d.kelompok, d.request ? `${d.modul}\n(Req: ${d.request})` : d.modul, d.alatBahan, d.asisten, d.tanggal, d.sesi])
                : dataArr.map(d => [`${d.nama}\n${d.npm}`, d.request ? `${d.aktivitas}\n(Req: ${d.request})` : d.aktivitas, d.alatBahan, d.tanggal, d.sesi]);
            pdf.autoTable({ head: [cols], body: rows, startY: 35, margin: 15, styles: { fontSize: 7 } });
            pdf.save(`${titleStr}.pdf`);
        };

        // UI Event Attachments
        window.openForm = (t) => {
            window.hideAllForms();
            document.getElementById(`form-${t}`).classList.remove('hidden-section');
            document.getElementById(`form-${t}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
        window.hideAllForms = () => {
            document.getElementById('form-praktikum').classList.add('hidden-section');
            document.getElementById('form-penelitian').classList.add('hidden-section');
            document.getElementById('praktikumForm').reset();
            document.getElementById('penelitianForm').reset();
            document.getElementById('p-id').value = "";
            document.getElementById('n-id').value = "";
            document.getElementById('p-form-title').innerText = "Form Rencana Praktikum";
            document.getElementById('p-submit-btn').innerText = "Simpan Jadwal";
            document.getElementById('n-form-title').innerText = "Form Rencana Penelitian";
            document.getElementById('n-submit-btn').innerText = "Simpan Jadwal Penelitian";
        };
        window.toggleLog = (t) => document.getElementById(`log-${t}-section`).classList.toggle('hidden-section');
        window.closeModal = () => document.getElementById('success-modal').classList.add('hidden-section');
        window.closeDailyModal = () => document.getElementById('daily-modal').classList.add('hidden-section');
        
        document.getElementById('btn-open-p').onclick = () => window.openForm('praktikum');
        document.getElementById('btn-open-n').onclick = () => window.openForm('penelitian');
        document.getElementById('btn-toggle-p').onclick = () => window.toggleLog('praktikum');
        document.getElementById('btn-toggle-n').onclick = () => window.toggleLog('penelitian');
        document.getElementById('btn-pdf-p').onclick = () => window.downloadPDF('praktikum');
        document.getElementById('btn-pdf-n').onclick = () => window.downloadPDF('penelitian');
        document.getElementById('btn-open-daily').onclick = () => window.openDailyModal();

        function showSuccessModal(msg) {
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('success-modal').classList.remove('hidden-section');
        }
    </script>
</body>
</html>